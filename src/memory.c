/*--------------------------------------------------------------------------------------------------------------------*/

#include "bridge.h"

#include "external/mongoose.h"

/*--------------------------------------------------------------------------------------------------------------------*/

size_t nyx_memory_free(buff_t buff)
{
    if(buff == NULL)
    {
        return 0x00;
    }

    /*----------------------------------------------------------------------------------------------------------------*/

#ifdef HAVE_MALLOC_SIZE
    size_t result = malloc_size(buff);
#endif

#ifdef HAVE_MALLOC_USABLE_SIZE
    size_t result = malloc_usable_size(buff);
#endif

    /*----------------------------------------------------------------------------------------------------------------*/

    free(buff);

    /*----------------------------------------------------------------------------------------------------------------*/

#if defined(HAVE_MALLOC_SIZE) || defined(HAVE_MALLOC_USABLE_SIZE)
    return result;
#else
    return 0x0000;
#endif
}

/*--------------------------------------------------------------------------------------------------------------------*/

buff_t nyx_memory_alloc(size_t size)
{
    if(size == 0x00)
    {
        return NULL;
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    buff_t result = malloc(size);

    if(result == NULL)
    {
        MG_ERROR(("Out of memory"));

        exit(1);
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    return result;
}

/*--------------------------------------------------------------------------------------------------------------------*/

buff_t nyx_memory_realloc(buff_t buff, size_t size)
{
    if(buff == NULL) {
        return nyx_memory_alloc(size);
    }

    if(size == 0x00) {
        nyx_memory_free(buff); return NULL;
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    buff_t result = realloc(buff, size);

    if(result == NULL)
    {
         MG_ERROR(("Out of memory"));

        exit(1);
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    return result;
}

/*--------------------------------------------------------------------------------------------------------------------*/

str_t nyx_string_dup(STR_t s)
{
    if(s != NULL)
    {
        size_t len = strlen(s);

        str_t str = nyx_memory_alloc(len + 1);

        memcpy(str, s, len);

        str[len] = '\0';

        return str;
    }

    return NULL;
}

/*--------------------------------------------------------------------------------------------------------------------*/

str_t nyx_string_ndup(STR_t s, size_t n)
{
    if(s != NULL)
    {
        size_t len = strnlen(s, n);

        str_t str = nyx_memory_alloc(len + 1);

        memcpy(str, s, len);

        str[len] = '\0';

        return str;
    }

    return NULL;
}

/*--------------------------------------------------------------------------------------------------------------------*/
