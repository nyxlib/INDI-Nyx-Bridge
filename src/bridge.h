/* INDI-Nyx Driver
 * Author: Jérôme ODIER <jerome.odier@lpsc.in2p3.fr>
 * SPDX-License-Identifier: GPL-2.0-only
 */

/*--------------------------------------------------------------------------------------------------------------------*/

#pragma once

#include <stddef.h>
#include <stdbool.h>

/*--------------------------------------------------------------------------------------------------------------------*/

#ifdef __cplusplus
extern "C" {
#endif

/*--------------------------------------------------------------------------------------------------------------------*/

typedef /*-*/ char *str_t;
typedef const char *STR_t;

/*--------------------------------------------------------------------------------------------------------------------*/
/* STRING BUILDER                                                                                                     */
/*--------------------------------------------------------------------------------------------------------------------*/

typedef struct
{
    struct nyx_string_builder_node_s *head;
    struct nyx_string_builder_node_s *tail;

} nyx_string_builder_t;

/*--------------------------------------------------------------------------------------------------------------------*/

nyx_string_builder_t *nyx_string_builder_new(void);

/*--------------------------------------------------------------------------------------------------------------------*/

void nyx_string_builder_free(
    /*-*/ nyx_string_builder_t *sb
);

/*--------------------------------------------------------------------------------------------------------------------*/

void nyx_string_builder_clear(
    /*-*/ nyx_string_builder_t *sb
);

/*--------------------------------------------------------------------------------------------------------------------*/

void nyx_string_builder_append_n(
    /*-*/ nyx_string_builder_t *sb,
    STR_t args[],
    size_t n,
    bool xml
);

/*--------------------------------------------------------------------------------------------------------------------*/

size_t nyx_string_builder_length(
    const nyx_string_builder_t *sb
);

/*--------------------------------------------------------------------------------------------------------------------*/

size_t nyx_string_builder_clength(
    const nyx_string_builder_t *sb
);

/*--------------------------------------------------------------------------------------------------------------------*/

str_t nyx_string_builder_to_string(
    const nyx_string_builder_t *sb
);

/*--------------------------------------------------------------------------------------------------------------------*/

str_t nyx_string_builder_to_cstring(
    const nyx_string_builder_t *sb
);

/*--------------------------------------------------------------------------------------------------------------------*/

#define nyx_string_builder_append(sb, ...) ({                                                                          \
                                                                                                                       \
    STR_t args[] = {__VA_ARGS__};                                                                                      \
                                                                                                                       \
    nyx_string_builder_append_n(sb, args, sizeof(args) / sizeof(STR_t), false);                                        \
})

/*--------------------------------------------------------------------------------------------------------------------*/

#define nyx_string_builder_append_xml(sb, ...) ({                                                                      \
                                                                                                                       \
    STR_t args[] = {__VA_ARGS__};                                                                                      \
                                                                                                                       \
    nyx_string_builder_append_n(sb, args, sizeof(args) / sizeof(STR_t), true);                                         \
})

/*--------------------------------------------------------------------------------------------------------------------*/

#define nyx_string_builder_from(...) ({                                                                                \
                                                                                                                       \
    STR_t args[] = {__VA_ARGS__};                                                                                      \
                                                                                                                       \
    nyx_string_builder_t *_sb = nyx_string_builder_new();                                                              \
                                                                                                                       \
    nyx_string_builder_append_n(_sb, args, sizeof(args) / sizeof(STR_t), false);                                       \
                                                                                                                       \
    _sb;                                                                                                               \
})

/*--------------------------------------------------------------------------------------------------------------------*/

#define nyx_string_builder_from_xml(...) ({                                                                            \
                                                                                                                       \
    STR_t args[] = {__VA_ARGS__};                                                                                      \
                                                                                                                       \
    nyx_string_builder_t *_sb = nyx_string_builder_new();                                                              \
                                                                                                                       \
    nyx_string_builder_append_n(_sb, args, sizeof(args) / sizeof(STR_t), true);                                        \
                                                                                                                       \
    _sb;                                                                                                               \
})

/*--------------------------------------------------------------------------------------------------------------------*/
/* XML -> JSON                                                                                                        */
/*--------------------------------------------------------------------------------------------------------------------*/

typedef void (*nyx_x2j_emit_fn)(size_t len, STR_t json);

/*--------------------------------------------------------------------------------------------------------------------*/

typedef struct nyx_x2j_ctx_s nyx_x2j_ctx_t;

/*--------------------------------------------------------------------------------------------------------------------*/

nyx_x2j_ctx_t *nyx_x2j_init(
    nyx_x2j_emit_fn emit
);

void nyx_x2j_close(
    nyx_x2j_ctx_t *ctx
);

void nyx_x2j_feed(
    const nyx_x2j_ctx_t *ctx,
    size_t len,
    STR_t text
);

/*--------------------------------------------------------------------------------------------------------------------*/
/* JSON -> XML                                                                                                        */
/*--------------------------------------------------------------------------------------------------------------------*/

typedef void (*nyx_j2x_emit_fn)(size_t len, STR_t xml);

/*--------------------------------------------------------------------------------------------------------------------*/

typedef struct nyx_j2x_ctx_s nyx_j2x_ctx_t;

/*--------------------------------------------------------------------------------------------------------------------*/

nyx_j2x_ctx_t *nyx_j2x_init(
    nyx_x2j_emit_fn emit
);

void nyx_j2x_feed(
    nyx_j2x_ctx_t *ctx,
    size_t len,
    STR_t text
);

void nyx_j2x_close(
    nyx_j2x_ctx_t *ctx
);

/*--------------------------------------------------------------------------------------------------------------------*/
/* BRIDGE                                                                                                             */
/*--------------------------------------------------------------------------------------------------------------------*/

void nyx_bridge_initialize();

void nyx_bridge_finalize();

/*--------------------------------------------------------------------------------------------------------------------*/

void nyx_bridge_poll(
    const char *indi_url,
    const char *mqtt_url,
    const char *mqtt_username,
    const char *mqtt_password,
    int ms
);

/*--------------------------------------------------------------------------------------------------------------------*/

#ifdef __cplusplus
}
#endif

/*--------------------------------------------------------------------------------------------------------------------*/
