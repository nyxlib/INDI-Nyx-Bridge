/*--------------------------------------------------------------------------------------------------------------------*/

#include <regex.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#include "bridge.h"

/*--------------------------------------------------------------------------------------------------------------------*/

static str_t read_entire_file(STR_t path)
{
    /*---------------------------------------------------------------------------------------------------------------*/

    FILE *fp = fopen(path, "rb");

    if(fp == NULL)
    {
        return NULL;
    }

    /*---------------------------------------------------------------------------------------------------------------*/

    nyx_string_builder_t *sb = nyx_string_builder_new();

    /*----------------------------------------------------------------------------------------------------------------*/

    char chunk[4096];

    size_t n;

    do {
        /*------------------------------------------------------------------------------------------------------------*/

        n = fread(chunk, 1, sizeof(chunk), fp);

        if(n > 0)
        {
            /*--------------------------------------------------------------------------------------------------------*/

            for(size_t i = 0; i < n; i++)
            {
                if(chunk[i] == '\0')
                {
                    chunk[i] = ' ';
                }
            }

            /*--------------------------------------------------------------------------------------------------------*/

            nyx_string_builder_append_buff(sb, NYX_SB_NO_ESCAPE, n, chunk);

            /*--------------------------------------------------------------------------------------------------------*/
        }

        /*------------------------------------------------------------------------------------------------------------*/

    } while(n == sizeof(chunk));

    /*----------------------------------------------------------------------------------------------------------------*/

    fclose(fp);

    /*----------------------------------------------------------------------------------------------------------------*/

    str_t result = nyx_string_builder_to_string(sb);
    nyx_string_builder_free(sb);
    return result;

    /*----------------------------------------------------------------------------------------------------------------*/
}

/*--------------------------------------------------------------------------------------------------------------------*/

static char indi_url[64];

#define DEFAULT_INDI_PORT 7624

/*--------------------------------------------------------------------------------------------------------------------*/

STR_t nyx_discover_indi_url(void)
{
    /*----------------------------------------------------------------------------------------------------------------*/
    /* DISCOVER PORT                                                                                                  */
    /*----------------------------------------------------------------------------------------------------------------*/

    int port = DEFAULT_INDI_PORT;

    /*----------------------------------------------------------------------------------------------------------------*/

    char path[64];

    snprintf(path, sizeof(path), "/proc/%d/cmdline", (int) getppid());

    str_t content = read_entire_file(path);

    /*----------------------------------------------------------------------------------------------------------------*/

    if(content != NULL)
    {
        /*------------------------------------------------------------------------------------------------------------*/

        regex_t re;

        if(regcomp(&re, "-p[[:space:]]*([0-9]+)", REG_EXTENDED) == 0)
        {
            /*--------------------------------------------------------------------------------------------------------*/

            regmatch_t m[2];

            if(regexec(&re, content, 2, m, 0) == 0 && m[1].rm_so >= 0)
            {
                /*----------------------------------------------------------------------------------------------------*/

                char buff[32];

                size_t k = (size_t) m[1].rm_eo
                           -
                           (size_t) m[1].rm_so
                ;

                if(k > sizeof(buff) - 1)
                {
                    k = sizeof(buff) - 1;
                }

                strncpy(buff, content + m[1].rm_so, k)[k] = '\0';

                /*----------------------------------------------------------------------------------------------------*/

                port = (int) strtol(buff, NULL, 10);

                /*----------------------------------------------------------------------------------------------------*/
            }

            /*--------------------------------------------------------------------------------------------------------*/

            regfree(&re);

            /*--------------------------------------------------------------------------------------------------------*/
        }

        /*------------------------------------------------------------------------------------------------------------*/

        free(content);

        /*------------------------------------------------------------------------------------------------------------*/
    }

    /*----------------------------------------------------------------------------------------------------------------*/
    /* BUILD ADDRESS                                                                                                  */
    /*----------------------------------------------------------------------------------------------------------------*/

    snprintf(indi_url, sizeof(indi_url), "tcp://localhost:%d", port);

    /*----------------------------------------------------------------------------------------------------------------*/

    return indi_url;
}

/*--------------------------------------------------------------------------------------------------------------------*/
